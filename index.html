<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Community & Chat App</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    .custom-scrollbar::-webkit-scrollbar {
      width: 6px;
    }
    .custom-scrollbar::-webkit-scrollbar-thumb {
      background: #9ca3af;
      border-radius: 4px;
    }
    .custom-scrollbar::-webkit-scrollbar-track {
      background: #f3f4f6;
    }
  </style>
</head>
<body class="bg-gray-100 min-h-screen flex flex-col">

  <!-- Navbar -->
  <nav class="bg-indigo-600 text-white p-4 shadow">
    <div class="flex justify-between items-center">
      <h1 class="text-xl font-bold">Community & Chat</h1>
      <span id="user-id" class="text-sm"></span>
    </div>
  </nav>

  <!-- Tabs -->
  <div class="flex justify-center bg-white shadow">
    <button class="tab-btn px-4 py-2" data-tab="random-chat">Random Chat</button>
    <button class="tab-btn px-4 py-2" data-tab="group-chat">Group Chat</button>
    <button class="tab-btn px-4 py-2" data-tab="community">Community</button>
  </div>

  <!-- Container -->
  <div class="flex-1 p-4 overflow-y-auto custom-scrollbar">
    <!-- Random Chat -->
    <div id="random-chat" class="tab-content hidden">
      <div id="chat-container" class="bg-white rounded-xl shadow p-4 h-[400px] flex flex-col">
        <div id="chat-box" class="flex-1 overflow-y-auto space-y-2 mb-2 custom-scrollbar"></div>
        <div class="flex gap-2">
          <input id="chat-input" type="text" placeholder="Type a message..." class="flex-1 border rounded-lg px-3 py-2" />
          <button id="send-btn" class="bg-indigo-600 text-white px-4 rounded-lg">Send</button>
        </div>
        <div class="mt-2 flex justify-between">
          <button id="find-btn" class="bg-green-500 text-white px-3 py-1 rounded-lg">Find Stranger</button>
          <button id="leave-btn" class="bg-red-500 text-white px-3 py-1 rounded-lg hidden">Leave</button>
        </div>
        <div class="mt-2 text-sm text-gray-500">Or chat with AI:</div>
        <div class="flex gap-2 mt-1">
          <input id="ai-input" type="text" placeholder="Ask AI..." class="flex-1 border rounded-lg px-3 py-2" />
          <button id="ai-btn" class="bg-purple-600 text-white px-4 rounded-lg">Ask</button>
        </div>
      </div>
    </div>

    <!-- Group Chat -->
    <div id="group-chat" class="tab-content hidden">
      <div class="bg-white rounded-xl shadow p-4 h-[400px] flex flex-col">
        <div class="flex gap-2 mb-2">
          <input id="room-id-input" type="text" placeholder="Enter room ID" class="flex-1 border rounded-lg px-3 py-2" />
          <button id="join-room-btn" class="bg-green-600 text-white px-4 rounded-lg">Join</button>
        </div>
        <div id="group-chat-box" class="flex-1 overflow-y-auto space-y-2 mb-2 custom-scrollbar"></div>
        <div class="flex gap-2">
          <input id="group-input" type="text" placeholder="Type a message..." class="flex-1 border rounded-lg px-3 py-2" />
          <button id="group-send-btn" class="bg-indigo-600 text-white px-4 rounded-lg">Send</button>
        </div>
      </div>
    </div>

    <!-- Community -->
    <div id="community" class="tab-content hidden">
      <div class="bg-white rounded-xl shadow p-4">
        <textarea id="post-input" placeholder="Share your thoughts..." class="w-full border rounded-lg px-3 py-2 mb-2 resize-none"></textarea>
        <button id="post-btn" class="bg-indigo-600 text-white px-4 py-2 rounded-lg">Post</button>
        <div id="posts-container" class="mt-4 divide-y divide-gray-200"></div>
      </div>
    </div>
  </div>

  <!-- Firebase -->
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-app.js";
    import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-auth.js";
    import { getFirestore, doc, setDoc, addDoc, collection, query, orderBy, onSnapshot, serverTimestamp } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore.js";

    // âœ… Your Firebase Config
    const firebaseConfig = {
      apiKey: "AIzaSyBFwj2eyLRhnolyfXCmEXmPCdBqen5epH4",
      authDomain: "blogs-d6e36.firebaseapp.com",
      projectId: "blogs-d6e36",
      storageBucket: "blogs-d6e36.firebasestorage.app",
      messagingSenderId: "919635572942",
      appId: "1:919635572942:web:58d516d3680b28801eb89f",
      measurementId: "G-8JR0P4VJ03"
    };

    // Init
    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);

    let userId = null;

    // Tabs
    document.querySelectorAll(".tab-btn").forEach(btn => {
      btn.addEventListener("click", () => {
        document.querySelectorAll(".tab-content").forEach(c => c.classList.add("hidden"));
        document.getElementById(btn.dataset.tab).classList.remove("hidden");
      });
    });

    // Auth
    const userIdDisplay = document.getElementById("user-id");
    onAuthStateChanged(auth, (user) => {
      if (user) {
        userId = user.uid;
        userIdDisplay.textContent = `User: ${userId.substring(0,8)}...`;
      } else {
        signInAnonymously(auth).catch(console.error);
      }
    });

    // âœ… Random Chat (basic mockup, real stranger pairing needs server logic)
    const chatBox = document.getElementById("chat-box");
    const chatInput = document.getElementById("chat-input");
    const sendBtn = document.getElementById("send-btn");
    const findBtn = document.getElementById("find-btn");
    const leaveBtn = document.getElementById("leave-btn");

    function addMessage(sender, text) {
      const div = document.createElement("div");
      div.className = sender === "You" ? "text-right" : "text-left";
      div.innerHTML = `<span class="inline-block bg-gray-200 rounded-lg px-3 py-1">${escapeHTML(text)}</span>`;
      chatBox.appendChild(div);
      chatBox.scrollTop = chatBox.scrollHeight;
    }

    sendBtn.addEventListener("click", () => {
      if (chatInput.value.trim()) {
        addMessage("You", chatInput.value.trim());
        chatInput.value = "";
      }
    });

    leaveBtn.addEventListener("click", () => {
      chatBox.innerHTML = "";
      leaveBtn.classList.add("hidden");
      findBtn.classList.remove("hidden");
    });

    // âœ… AI Chat (just fun, reverses text)
    const aiInput = document.getElementById("ai-input");
    const aiBtn = document.getElementById("ai-btn");
    aiBtn.addEventListener("click", () => {
      const q = aiInput.value.trim();
      if (!q) return;
      addMessage("You", q);
      setTimeout(() => addMessage("AI", "ðŸ¤– " + q.split("").reverse().join("")), 500);
      aiInput.value = "";
    });

    // âœ… Group Chat
    const groupChatBox = document.getElementById("group-chat-box");
    const groupInput = document.getElementById("group-input");
    const groupSendBtn = document.getElementById("group-send-btn");
    const joinRoomBtn = document.getElementById("join-room-btn");
    let currentRoom = null;

    joinRoomBtn.addEventListener("click", () => {
      const roomId = document.getElementById("room-id-input").value.trim();
      if (!roomId) return;
      currentRoom = roomId;
      const roomRef = collection(db, "rooms", roomId, "messages");
      const q = query(roomRef, orderBy("timestamp"));
      onSnapshot(q, (snap) => {
        groupChatBox.innerHTML = "";
        snap.forEach(doc => {
          const m = doc.data();
          const div = document.createElement("div");
          div.className = m.sender === userId ? "text-right" : "text-left";
          div.innerHTML = `<span class="inline-block bg-gray-200 rounded-lg px-3 py-1">${escapeHTML(m.text)}</span>`;
          groupChatBox.appendChild(div);
        });
        groupChatBox.scrollTop = groupChatBox.scrollHeight;
      });
    });

    groupSendBtn.addEventListener("click", async () => {
      if (!currentRoom || !groupInput.value.trim()) return;
      await addDoc(collection(db, "rooms", currentRoom, "messages"), {
        sender: userId,
        text: groupInput.value.trim(),
        timestamp: serverTimestamp()
      });
      groupInput.value = "";
    });

    // âœ… Community Posts
    const postBtn = document.getElementById("post-btn");
    const postInput = document.getElementById("post-input");
    const postsContainer = document.getElementById("posts-container");

    postBtn.addEventListener("click", async () => {
      const text = postInput.value.trim();
      if (!text) return;
      await addDoc(collection(db, "posts"), {
        text,
        userId,
        timestamp: serverTimestamp()
      });
      postInput.value = "";
    });

    const postsQuery = query(collection(db, "posts"), orderBy("timestamp", "desc"));
    onSnapshot(postsQuery, (snap) => {
      postsContainer.innerHTML = "";
      snap.forEach(doc => {
        const p = doc.data();
        const div = document.createElement("div");
        div.className = "py-2";
        const time = p.timestamp?.toDate ? p.timestamp.toDate().toLocaleString() : "Just now";
        div.innerHTML = `<p>${escapeHTML(p.text)}</p><p class="text-xs text-gray-500">By ${p.userId?.substring(0,8)} â€¢ ${time}</p>`;
        postsContainer.appendChild(div);
      });
    });

    // âœ… Escape HTML
    function escapeHTML(str) {
      return str.replace(/[&<>"']/g, (m) => ({
        "&": "&amp;", "<": "&lt;", ">": "&gt;", '"': "&quot;", "'": "&#39;"
      })[m]);
    }
  </script>
</body>
</html>

